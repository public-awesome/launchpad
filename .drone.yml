---
kind: pipeline
type: docker
name: default-build

platform:
  os: linux
  arch: amd64

workspace:
  path: /code

steps:
  - name: restore-cache
    image: meltwater/drone-cache:dev
    volumes:
      - name: cache
        path: /code/target
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: minio_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: minio_secret_key
  - name: build-contracts
    image: cosmwasm/workspace-optimizer:0.12.8
  - name: full_test
    image: publicawesome/golang:1.18.0-devtooling
    commands:
      - mkdir -p e2e/contracts
      - cp artifacts/*.wasm e2e/contracts/
      - cd e2e/
      - go test . -v
  - name: rebuild-cache
    image: meltwater/drone-cache:dev
    volumes:
      - name: cache
        path: /code/target
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: minio_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: minio_secret_key
    pull: true
    settings:
      rebuild: true
      bucket:
        from_secret: minio_bucket
      region: us-east-1
      mount:
        - "/code/target"
volumes:
  - name: cache
    temp: {}

node:
  runner: integration

trigger:
  branch:
    - main
  event:
    - pull_request
    - push
---
kind: signature
hmac: a4416cff0bbe8fe16efdf8057cc5b69e33eec777967439885795879eae7db0f8

...
